From 505bcda6ec03056606747ebf842e2c38a50106ab Mon Sep 17 00:00:00 2001
From: Tobias Tefke <tobias.tefke@gmail.com>
Date: Sun, 1 Apr 2018 16:08:35 +0200
Subject: [PATCH 3/3] Do not check for crypto magic on MTK devices

Change-Id: I9f73cd500ca36622ef09841bed63dbf15cef0538
---
 cryptfs.c | 4 ++++
 cryptfs.h | 3 +++
 2 files changed, 7 insertions(+)

diff --git a/cryptfs.c b/cryptfs.c
index b25510f..058c668 100644
--- a/cryptfs.c
+++ b/cryptfs.c
@@ -953,10 +953,12 @@ static int get_crypt_ftr_and_key(struct crypt_mnt_ftr *crypt_ftr)
     goto errout;
   }
 
+#ifndef BOARD_HAS_MTK_HARDWARE
   if (crypt_ftr->magic != CRYPT_MNT_MAGIC) {
     SLOGE("Bad magic for real block device %s\n", fname);
     goto errout;
   }
+#endif
 
   if (crypt_ftr->major_version != CURRENT_MAJOR_VERSION) {
     SLOGE("Cannot understand major version %d real block device footer; expected %d\n",
@@ -2504,7 +2506,9 @@ static int cryptfs_init_crypt_mnt_ftr(struct crypt_mnt_ftr *ftr)
     off64_t off;
 
     memset(ftr, 0, sizeof(struct crypt_mnt_ftr));
+#ifndef BOARD_HAS_MTK_HARDWARE
     ftr->magic = CRYPT_MNT_MAGIC;
+#endif
     ftr->major_version = CURRENT_MAJOR_VERSION;
     ftr->minor_version = CURRENT_MINOR_VERSION;
     ftr->ftr_size = sizeof(struct crypt_mnt_ftr);
diff --git a/cryptfs.h b/cryptfs.h
index e4c44f0..5768e59 100644
--- a/cryptfs.h
+++ b/cryptfs.h
@@ -81,7 +81,10 @@
 #define CRYPT_TYPE_PIN      3 /* master_key is encrypted with a pin */
 #define CRYPT_TYPE_MAX_TYPE 3 /* type cannot be larger than this value */
 
+#ifndef BOARD_HAS_MTK_HARDWARE
 #define CRYPT_MNT_MAGIC 0xD0B5B1C4
+#endif
+
 #define PERSIST_DATA_MAGIC 0xE950CD44
 
 /* Key Derivation Function algorithms */
-- 
2.16.2

